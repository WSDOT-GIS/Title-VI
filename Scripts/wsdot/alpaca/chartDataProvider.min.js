define(["dojo/_base/declare","dojo/Deferred","dojo/Evented","esri/config","esri/graphic","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/StatisticDefinition","esri/tasks/RelationParameters","./raceData","./languageData","./ageData","./veteranData","./povertyData","./utils","dojo/text!alpaca/aggregate_fields.txt"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){"use strict";function ot(n,t){for(var r=!1,i=0,u=n.length;i<u;i+=1)if(n[i]===t){r=!0;break}return r}function ft(n){this.alias=n.alias||null;this.domain=n.domain||null;this.editable=n.editable||!1;this.length=n.length||null;this.name=n.name||null;this.type=n.type||null}function st(n,t){return t&&t.name&&t.type?new ft(t):t}function d(n){var i,r,t;for(this.language=[],this.population=[],this.veteran=[],this.poverty=[],this.race=[],this.other=[],i=0,r=n.length;i<r;i+=1)t=n[i],t&&t.name&&!g.test(t.name)&&ut.test(t.type)?rt.test(t.name)?this.language.push(t):tt.test(t.name)?this.population.push(t):a.fieldRegExp.test(t.name)?this.veteran.push(t):it.test(t.name)?this.poverty.push(t):nt.test(t.name)?this.race.push(t):this.other.push(t):this.other.push(t)}function b(n){this.race=n.race?new h(n.race):new h(n);this.language=n.language?new c(n.language):new c(n);this.age=n.age?new l(n.age):new l(n);this.veteran=n.veteran?new a(n.age):new a(n);this.poverty=n.poverty?new v(n.poverty):new v(n)}function k(n,t,i,r){this.type=n||null;this.features=t||null;this.chartData=i instanceof b?i:new b(i);this.originalGeometry=r||null}function et(n){var r={},u,e,i,t,f;for(f=n.features?n.features:n,u=0,e=f.length;u<e;u+=1){i=f[u];for(t in i.attributes)i.attributes.hasOwnProperty(t)&&(r[t]?r[t]+=i.attributes[t]:r[t]=i.attributes[t])}return new b(r)}function ht(n){return n.geometry}var w,g,nt,tt,it,rt,ut;return g=/^ME/,rt=/^(?:Total(?:(?:English)|(?:Spanish)|(?:IndoEuropean)|(?:AsianPacificIsland)|(?:Other)))$/i,tt=/^[MF]_([0-9]{1,2})?([a-z]+)?[0-9]+$/i,it=/^((?:Total_POV)|(?:Poverty_(?:Fed)|(?:State))|(?:PctPoverty)|(?:Income))$/i,nt=/^(?:(?:(?:Not)?White)|(?:AfricanAmerican_Black)|(?:AmericanIndian_AlaskaNative)|(?:AsianAlone)|(?:NativeHawaiian_PacificIsl)|(?:SomeOtherRace)|(?:TwoOrMoreRaces))$/i,ut=/(?:Integer)|(?:Double})/i,ft.prototype.toStatisticDefinition=function(n,t){var i;return i=new o,i.onStatisticField=this.name,i.statisticType=n||"sum",i.outStatisticFieldName=t||this.name,i},d.prototype.toStatisticDefinitions=function(){function t(n){return n.toStatisticDefinition()}var n=[];return n=n.concat(this.language.map(t)),n=n.concat(this.population.map(t)),n=n.concat(this.veteran.map(t)),n=n.concat(this.poverty.map(t)),n.concat(this.race.map(t))},d.prototype.getOutFields=function(){function t(n){return n.name}var n=[];return n=n.concat(this.language.map(t)),n=n.concat(this.population.map(t)),n=n.concat(this.veteran.map(t)),n=n.concat(this.poverty.map(t)),n.concat(this.race.map(t))},p=JSON.parse(p,st),p=new d(p),w=n(i,{_statisticDefinitions:p.toStatisticDefinitions(),queryTasks:{blockGroup:null,tract:null,county:null},getQueryTaskForScale:function(n){var t;return t=y.getLevel(n),this.queryTasks[t]},getSelectionGraphics:function(n,i,e,o){function v(){var n=r.defaults.geometryService;return n||function(){var n=new TypeError("esri/config.defaults.geometryService not defined.");c.reject(n);h.emit("error",n)}(),n}function b(){var n,t;t=h.getQueryTaskForScale(i);n=new f;l="statewide";n.outStatistics=h._statisticDefinitions;t.execute(n,function(n){var i,t;i=n.features[0].attributes;t=new k(l,null,i);h.emit("totals-determined",t.chartData);h.emit("query-complete",t);c.resolve(t)},function(t){var i={type:l,query:n,error:t};h.emit("error",i);c.reject(i)})}function y(n){h.emit("totals-determined",n);c.progress({message:"totals determined",totals:n})}function w(t){var r,w;w=h.getQueryTaskForScale(i);r=new f;r.geometry=t;r.outFields=p.getOutFields();r.returnGeometry=!0;w.execute(r,function(t){function b(r){for(var f,a=[],e=[],o,u=0,s=r.length;u<s;u+=1)f=r[u],ot(a,f.geometry1Index)||(e.push(t.features[f.geometry1Index]),a.push(f.geometry1Index));o=et(e);y(o);i=new k(l,e,o,n);c.resolve(i);h.emit("query-complete",i)}var r,p,w,i,f;p=t.features.map(ht);e?(r=et(t),y(r),a=v(),a.union(p,function(n){w=new u(n,null,r);i=new k(l,[w],r,null);h.emit("query-complete",i);c.resolve(i)},function(n){n.totals=r;c.reject(n)})):(f=new s,f.geometries1=p,f.geometries2=[o],f.relation=s.SPATIAL_REL_INTERIORINTERSECTION,a.relation(f,b,function(n){c.reject(n)}))},function(n){h.emit("error",n);c.reject(n)})}var h=this,c=new t,l,a;return l=n?e?"service area":"selection":"statewide",n?o?(a=v(),a.intersect([n],o,function(n){n&&n.length>=1&&w(n[0])},function(n){h.emit("intersect error",n);c.reject(n)})):w(n):b(),c.promise},constructor:function(n,t){if(!n)throw new TypeError("The map service URL was not provided.");t||(t={blockGroupLayerId:0,tractLayerId:1,countyLayerId:2});/\/$/.test(n)||(n+="/");this.queryTasks.blockGroup=new e(n+String(t.blockGroupLayerId));this.queryTasks.tract=new e(n+String(t.tractLayerId));this.queryTasks.county=new e(n+String(t.countyLayerId))}}),w.ChartData=b,w.ChartDataQueryResult=k,w});
//# sourceMappingURL=chartDataProvider.min.js.map